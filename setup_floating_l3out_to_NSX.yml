---

# Notes
# - Physical and L3 Domains must be setup prior to running this script
# - Local AS is hardcoded to 65530
# - Anchor1 & 2 should be in the same DC as nsx_ip1, anchor3 & 4 should be in the same DC as nsx_ip2

- name: Create floating L3out to NSX Edge nodes (from tenant VISMA_IT_Transit)
  hosts: apic1
  gather_facts: no

  vars:
    # This was used under the VCD/NSX POC
    tenant: VISMA_IT_Transit
    vrf: DC_transfer
    l3out_name: DC_transfer-VCD-NSX-2
    l3domain: VCD-POC_L3Dom
    physdomain: VCD-POC
    vlan: 1983       #both domains must contain this vlan id!
    anchor1: pod-1/node-111
    anchor1_ip: 10.36.7.2/28
    anchor2: pod-1/node-112
    anchor2_ip: 10.36.7.3/28
    anchor3: pod-2/node-211
    anchor3_ip: 10.36.7.4/28
    anchor4: pod-2/node-212
    anchor4_ip: 10.36.7.5/28
    floating_ip: 10.36.7.1/28
    nsx_ip1: 10.36.7.6
    nsx_ip2: 10.36.7.7
    nsx_asn: '64546'
    advertise_to_nsx: 10.0.0.0/8


  tasks:
    - name: Create L3out {{l3out_name}} (using JSON string)
      cisco.aci.aci_rest:
        host: '{{ ansible_hostname }}'
        username: '{{ ansible_username }}'
        password: '{{ ansible_password }}'
        validate_certs: false
        path: /api/mo/uni.json
        method: post
        content:
          {
             "l3extOut":{
                "attributes":{
                   "annotation":"orchestrator:ansible",
                   "descr":"",
                   "dn":"uni/tn-{{tenant}}/out-{{l3out_name}}",
                   "enforceRtctrl":"export",
                   "mplsEnabled":"no",
                   "name":"{{l3out_name}}",
                   "nameAlias":"",
                   "ownerKey":"",
                   "ownerTag":"",
                   "targetDscp":"unspecified",
                   "userdom":":all:"
                },
                "children":[
                   {
                      "l3extRsL3DomAtt":{
                         "attributes":{
                            "annotation":"orchestrator:ansible",
                            "tDn":"uni/l3dom-{{l3domain}}",
                            "userdom":":all:"
                         }
                      }
                   },
                   {
                      "l3extRsEctx":{
                         "attributes":{
                            "annotation":"orchestrator:ansible",
                            "tnFvCtxName":"{{vrf}}",
                            "userdom":"all"
                         }
                      }
                   },
                   {
                      "l3extLNodeP":{
                         "attributes":{
                            "annotation":"orchestrator:ansible",
                            "configIssues":"",
                            "descr":"",
                            "name":"{{l3out_name}}_nodeProfile",
                            "nameAlias":"",
                            "ownerKey":"",
                            "ownerTag":"",
                            "tag":"yellow-green",
                            "targetDscp":"unspecified",
                            "userdom":":all:"
                         },
                         "children":[
                            {
                               "l3extRsNodeL3OutAtt":{
                                  "attributes":{
                                     "annotation":"orchestrator:ansible",
                                     "configIssues":"",
                                     "rtrId": "10.0.0.{{ anchor1[-3:] }}",
                                     "rtrIdLoopBack": "no",
                                     "tDn": "topology/{{ anchor1 }}",
                                     "userdom":":all:"
                                  }
                               }
                            },
                            {
                               "l3extRsNodeL3OutAtt":{
                                  "attributes":{
                                     "annotation":"orchestrator:ansible",
                                     "configIssues":"",
                                     "rtrId": "10.0.0.{{ anchor2[-3:] }}",
                                     "rtrIdLoopBack": "no",
                                     "tDn": "topology/{{ anchor2 }}",
                                     "userdom":":all:"
                                  }
                               }
                            },
                            {
                               "l3extRsNodeL3OutAtt":{
                                  "attributes":{
                                     "annotation":"orchestrator:ansible",
                                     "configIssues":"",
                                     "rtrId": "10.0.0.{{ anchor3[-3:] }}",
                                     "rtrIdLoopBack": "no",
                                     "tDn": "topology/{{ anchor3 }}",
                                     "userdom":":all:"
                                  }
                               }
                            },
                            {
                               "l3extRsNodeL3OutAtt":{
                                  "attributes":{
                                     "annotation":"orchestrator:ansible",
                                     "configIssues":"",
                                     "rtrId": "10.0.0.{{ anchor4[-3:] }}",
                                     "rtrIdLoopBack": "no",
                                     "tDn": "topology/{{ anchor4 }}",
                                     "userdom":":all:"
                                  }
                               }
                            },
                            {
                               "l3extLIfP":{
                                  "attributes":{
                                     "annotation":"orchestrator:ansible",
                                     "descr":"",
                                     "name":"{{l3out_name}}_interfaceProfile",
                                     "nameAlias":"",
                                     "ownerKey":"",
                                     "ownerTag":"",
                                     "prio":"unspecified",
                                     "tag":"yellow-green",
                                     "userdom":":all:"
                                  },
                                  "children":[
                                     {
                                        "l3extVirtualLIfP":{
                                           "attributes":{
                                              "addr":"{{anchor1_ip}}",
                                              "annotation":"orchestrator:ansible",
                                              "autostate":"disabled",
                                              "descr":"",
                                              "encap":"vlan-{{vlan}}",
                                              "encapScope":"local",
                                              "ifInstT":"ext-svi",
                                              "ipv6Dad":"enabled",
                                              "llAddr":"::",
                                              "mac":"00:22:BD:F8:19:FF",
                                              "mode":"regular",
                                              "mtu":"inherit",
                                              "name":"",
                                              "nodeDn":"topology/{{ anchor1 }}",
                                              "targetDscp":"unspecified",
                                              "userdom":":all:"
                                           },
                                           "children":[
                                              {
                                                 "l3extRsDynPathAtt":{
                                                    "attributes":{
                                                       "annotation":"orchestrator:ansible",
                                                       "floatingAddr":"{{floating_ip}}",
                                                       "forgedTransmit":"Disabled",
                                                       "macChange":"Disabled",
                                                       "promMode":"Disabled",
                                                       "tDn":"uni/phys-{{physdomain}}",
                                                       "userdom":":all:"
                                                    }
                                                 }
                                              },
                                              {
                                                 "bgpPeerP":{
                                                    "attributes":{
                                                       "addr":"{{nsx_ip1}}",
                                                       "addrTCtrl":"af-ucast",
                                                       "adminSt":"enabled",
                                                       "allowedSelfAsCnt":"3",
                                                       "annotation":"orchestrator:ansible",
                                                       "ctrl":"",
                                                       "ctrlExt":"",
                                                       "descr":"",
                                                       "name":"",
                                                       "nameAlias":"",
                                                       "peerCtrl":"",
                                                       "privateASctrl":"",
                                                       "ttl":"1",
                                                       "userdom":":all:",
                                                       "weight":"0"
                                                    },
                                                    "children":[
                                                       {
                                                          "bgpRsPeerPfxPol":{
                                                             "attributes":{
                                                                "annotation":"orchestrator:ansible",
                                                                "tnBgpPeerPfxPolName":"",
                                                                "userdom":"all"
                                                             }
                                                          }
                                                       },
                                                       {
                                                          "bgpLocalAsnP":{
                                                             "attributes":{
                                                                "annotation":"orchestrator:ansible",
                                                                "asnPropagate":"replace-as",
                                                                "descr":"",
                                                                "localAsn":"65530",
                                                                "name":"",
                                                                "nameAlias":"",
                                                                "userdom":":all:"
                                                             }
                                                          }
                                                       },
                                                       {
                                                          "bgpAsP":{
                                                             "attributes":{
                                                                "annotation":"orchestrator:ansible",
                                                                "asn":"{{nsx_asn}}",
                                                                "descr":"",
                                                                "name":"",
                                                                "nameAlias":"",
                                                                "userdom":":all:"
                                                             }
                                                          }
                                                       }
                                                    ]
                                                 }
                                              }
                                           ]
                                        }
                                     },
                                     {
                                        "l3extVirtualLIfP":{
                                           "attributes":{
                                              "addr":"{{anchor2_ip}}",
                                              "annotation":"orchestrator:ansible",
                                              "autostate":"disabled",
                                              "descr":"",
                                              "encap":"vlan-{{vlan}}",
                                              "encapScope":"local",
                                              "ifInstT":"ext-svi",
                                              "ipv6Dad":"enabled",
                                              "llAddr":"::",
                                              "mac":"00:22:BD:F8:19:FF",
                                              "mode":"regular",
                                              "mtu":"inherit",
                                              "name":"",
                                              "nodeDn":"topology/{{ anchor2 }}",
                                              "targetDscp":"unspecified",
                                              "userdom":":all:"
                                           },
                                           "children":[
                                              {
                                                 "l3extRsDynPathAtt":{
                                                    "attributes":{
                                                       "annotation":"orchestrator:ansible",
                                                       "floatingAddr":"{{floating_ip}}",
                                                       "forgedTransmit":"Disabled",
                                                       "macChange":"Disabled",
                                                       "promMode":"Disabled",
                                                       "tDn":"uni/phys-{{physdomain}}",
                                                       "userdom":":all:"
                                                    }
                                                 }
                                              },
                                              {
                                                 "bgpPeerP":{
                                                    "attributes":{
                                                       "addr":"{{nsx_ip1}}",
                                                       "addrTCtrl":"af-ucast",
                                                       "adminSt":"enabled",
                                                       "allowedSelfAsCnt":"3",
                                                       "annotation":"orchestrator:ansible",
                                                       "ctrl":"",
                                                       "ctrlExt":"",
                                                       "descr":"",
                                                       "name":"",
                                                       "nameAlias":"",
                                                       "peerCtrl":"",
                                                       "privateASctrl":"",
                                                       "ttl":"1",
                                                       "userdom":":all:",
                                                       "weight":"0"
                                                    },
                                                    "children":[
                                                       {
                                                          "bgpRsPeerPfxPol":{
                                                             "attributes":{
                                                                "annotation":"orchestrator:ansible",
                                                                "tnBgpPeerPfxPolName":"",
                                                                "userdom":"all"
                                                             }
                                                          }
                                                       },
                                                       {
                                                          "bgpLocalAsnP":{
                                                             "attributes":{
                                                                "annotation":"orchestrator:ansible",
                                                                "asnPropagate":"replace-as",
                                                                "descr":"",
                                                                "localAsn":"65530",
                                                                "name":"",
                                                                "nameAlias":"",
                                                                "userdom":":all:"
                                                             }
                                                          }
                                                       },
                                                       {
                                                          "bgpAsP":{
                                                             "attributes":{
                                                                "annotation":"orchestrator:ansible",
                                                                "asn":"{{nsx_asn}}",
                                                                "descr":"",
                                                                "name":"",
                                                                "nameAlias":"",
                                                                "userdom":":all:"
                                                             }
                                                          }
                                                       }
                                                    ]
                                                 }
                                              }
                                           ]
                                        }
                                     },
                                     {
                                        "l3extVirtualLIfP":{
                                           "attributes":{
                                              "addr":"{{anchor3_ip}}",
                                              "annotation":"orchestrator:ansible",
                                              "autostate":"disabled",
                                              "descr":"",
                                              "encap":"vlan-{{vlan}}",
                                              "encapScope":"local",
                                              "ifInstT":"ext-svi",
                                              "ipv6Dad":"enabled",
                                              "llAddr":"::",
                                              "mac":"00:22:BD:F8:19:FF",
                                              "mode":"regular",
                                              "mtu":"inherit",
                                              "name":"",
                                              "nodeDn":"topology/{{ anchor3 }}",
                                              "targetDscp":"unspecified",
                                              "userdom":":all:"
                                           },
                                           "children":[
                                              {
                                                 "l3extRsDynPathAtt":{
                                                    "attributes":{
                                                       "annotation":"orchestrator:ansible",
                                                       "floatingAddr":"{{floating_ip}}",
                                                       "forgedTransmit":"Disabled",
                                                       "macChange":"Disabled",
                                                       "promMode":"Disabled",
                                                       "tDn":"uni/phys-{{physdomain}}",
                                                       "userdom":":all:"
                                                    }
                                                 }
                                              },
                                              {
                                                 "bgpPeerP":{
                                                    "attributes":{
                                                       "addr":"{{nsx_ip2}}",
                                                       "addrTCtrl":"af-ucast",
                                                       "adminSt":"enabled",
                                                       "allowedSelfAsCnt":"3",
                                                       "annotation":"orchestrator:ansible",
                                                       "ctrl":"",
                                                       "ctrlExt":"",
                                                       "descr":"",
                                                       "name":"",
                                                       "nameAlias":"",
                                                       "peerCtrl":"",
                                                       "privateASctrl":"",
                                                       "ttl":"1",
                                                       "userdom":":all:",
                                                       "weight":"0"
                                                    },
                                                    "children":[
                                                       {
                                                          "bgpRsPeerPfxPol":{
                                                             "attributes":{
                                                                "annotation":"orchestrator:ansible",
                                                                "tnBgpPeerPfxPolName":"",
                                                                "userdom":"all"
                                                             }
                                                          }
                                                       },
                                                       {
                                                          "bgpLocalAsnP":{
                                                             "attributes":{
                                                                "annotation":"orchestrator:ansible",
                                                                "asnPropagate":"replace-as",
                                                                "descr":"",
                                                                "localAsn":"65530",
                                                                "name":"",
                                                                "nameAlias":"",
                                                                "userdom":":all:"
                                                             }
                                                          }
                                                       },
                                                       {
                                                          "bgpAsP":{
                                                             "attributes":{
                                                                "annotation":"orchestrator:ansible",
                                                                "asn":"{{nsx_asn}}",
                                                                "descr":"",
                                                                "name":"",
                                                                "nameAlias":"",
                                                                "userdom":":all:"
                                                             }
                                                          }
                                                       }
                                                    ]
                                                 }
                                              }
                                           ]
                                        }
                                     },
                                     {
                                        "l3extVirtualLIfP":{
                                           "attributes":{
                                              "addr":"{{anchor4_ip}}",
                                              "annotation":"orchestrator:ansible",
                                              "autostate":"disabled",
                                              "descr":"",
                                              "encap":"vlan-{{vlan}}",
                                              "encapScope":"local",
                                              "ifInstT":"ext-svi",
                                              "ipv6Dad":"enabled",
                                              "llAddr":"::",
                                              "mac":"00:22:BD:F8:19:FF",
                                              "mode":"regular",
                                              "mtu":"inherit",
                                              "name":"",
                                              "nodeDn":"topology/{{ anchor4 }}",
                                              "targetDscp":"unspecified",
                                              "userdom":":all:"
                                           },
                                           "children":[
                                              {
                                                 "l3extRsDynPathAtt":{
                                                    "attributes":{
                                                       "annotation":"orchestrator:ansible",
                                                       "floatingAddr":"{{floating_ip}}",
                                                       "forgedTransmit":"Disabled",
                                                       "macChange":"Disabled",
                                                       "promMode":"Disabled",
                                                       "tDn":"uni/phys-{{physdomain}}",
                                                       "userdom":":all:"
                                                    }
                                                 }
                                              },
                                              {
                                                 "bgpPeerP":{
                                                    "attributes":{
                                                       "addr":"{{nsx_ip2}}",
                                                       "addrTCtrl":"af-ucast",
                                                       "adminSt":"enabled",
                                                       "allowedSelfAsCnt":"3",
                                                       "annotation":"orchestrator:ansible",
                                                       "ctrl":"",
                                                       "ctrlExt":"",
                                                       "descr":"",
                                                       "name":"",
                                                       "nameAlias":"",
                                                       "peerCtrl":"",
                                                       "privateASctrl":"",
                                                       "ttl":"1",
                                                       "userdom":":all:",
                                                       "weight":"0"
                                                    },
                                                    "children":[
                                                       {
                                                          "bgpRsPeerPfxPol":{
                                                             "attributes":{
                                                                "annotation":"orchestrator:ansible",
                                                                "tnBgpPeerPfxPolName":"",
                                                                "userdom":"all"
                                                             }
                                                          }
                                                       },
                                                       {
                                                          "bgpLocalAsnP":{
                                                             "attributes":{
                                                                "annotation":"orchestrator:ansible",
                                                                "asnPropagate":"replace-as",
                                                                "descr":"",
                                                                "localAsn":"65530",
                                                                "name":"",
                                                                "nameAlias":"",
                                                                "userdom":":all:"
                                                             }
                                                          }
                                                       },
                                                       {
                                                          "bgpAsP":{
                                                             "attributes":{
                                                                "annotation":"orchestrator:ansible",
                                                                "asn":"{{nsx_asn}}",
                                                                "descr":"",
                                                                "name":"",
                                                                "nameAlias":"",
                                                                "userdom":":all:"
                                                             }
                                                          }
                                                       }
                                                    ]
                                                 }
                                              }
                                           ]
                                        }
                                     },
                                     {
                                        "l3extRsNdIfPol":{
                                           "attributes":{
                                              "annotation":"orchestrator:ansible",
                                              "tnNdIfPolName":"",
                                              "userdom":"all"
                                           }
                                        }
                                     },
                                     {
                                        "l3extRsLIfPCustQosPol":{
                                           "attributes":{
                                              "annotation":"orchestrator:ansible",
                                              "tnQosCustomPolName":"",
                                              "userdom":"all"
                                           }
                                        }
                                     },
                                     {
                                        "l3extRsIngressQosDppPol":{
                                           "attributes":{
                                              "annotation":"orchestrator:ansible",
                                              "tnQosDppPolName":"",
                                              "userdom":"all"
                                           }
                                        }
                                     },
                                     {
                                        "l3extRsEgressQosDppPol":{
                                           "attributes":{
                                              "annotation":"orchestrator:ansible",
                                              "tnQosDppPolName":"",
                                              "userdom":"all"
                                           }
                                        }
                                     },
                                     {
                                        "l3extRsArpIfPol":{
                                           "attributes":{
                                              "annotation":"orchestrator:ansible",
                                              "tnArpIfPolName":"",
                                              "userdom":"all"
                                           }
                                        }
                                     }
                                  ]
                               }
                            }
                         ]
                      }
                   },
                   {
                      "l3extInstP":{
                         "attributes":{
                            "annotation":"orchestrator:ansible",
                            "descr":"",
                            "exceptionTag":"",
                            "floodOnEncap":"disabled",
                            "matchT":"AtleastOne",
                            "name":"{{l3out_name}}",
                            "nameAlias":"",
                            "prefGrMemb":"exclude",
                            "prio":"unspecified",
                            "targetDscp":"unspecified",
                            "userdom":":all:"
                         },
                         "children":[
                            {
                               "l3extSubnet":{
                                  "attributes":{
                                     "aggregate":"",
                                     "annotation":"orchestrator:ansible",
                                     "descr":"",
                                     "ip":"{{ advertise_to_nsx }}",
                                     "name":"",
                                     "nameAlias":"",
                                     "scope":"export-rtctrl",
                                     "userdom":":all:"
                                  }
                               }
                            },
                            {
                               "fvRsCustQosPol":{
                                  "attributes":{
                                     "annotation":"orchestrator:ansible",
                                     "tnQosCustomPolName":"",
                                     "userdom":"all"
                                  }
                               }
                            }
                         ]
                      }
                   },
                   {
                      "bgpExtP":{
                         "attributes":{
                            "annotation":"orchestrator:ansible",
                            "descr":"",
                            "nameAlias":"",
                            "userdom":":all:"
                         }
                      }
                   }
                ]
             }
          }



